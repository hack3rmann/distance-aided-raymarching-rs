## Сборка

Для сборки проекта необходимы линковщик `clang` и инструменты разработки на `rust` (rust toolchain), при их отсутствии:

```shell
sudo apt install rustup
rustup install stable
cargo --version
```

```output
cargo 1.76.0 (c84b36747 2024-01-18)
```

Сборка консольного приложения в режиме release. Для первой сборки понадобится подключение к интернету, чтобы `cargo` имел возможность подгрузить все необходимые библиотеки.

```shell
cargo build --release
```

Приложение будет находится в каталоге `target/release/` под названием `nairv_hw1_gpu`. Для запуска приложения в режиме замера производительности необходимо указать флаг `--bench` или `-b`. По умолчанию рендеринг изображения происходит с помощью GPU и  Vulkan, но можно и в однопоточном режиме на CPU `--type singlecpu`, и в многопоточном режиме CPU `--type multicpu`. По умолчанию размеры итоговой картинки без учёта скалирования *1024х512*, параметр скалирования можно изменить `--scale <N>` (по умолчанию $N=4$). Для дополнительной информации по всем доступным флагам `--help`. По умолчанию в директории запуска должен лежать файл `render_config.toml` (для его изменения его локации используется флаг `--cfg`). После успешной работы программы в каталоге вызова появится файл `out.png` (его название и директорию можно менять флагом `--out <DIR>`).

### Пример:

```shell
target/release/nairv_hw1_gpu --help
target/release/nairv_hw1_gpu --type gpu --scale 1 --bench
```

## Зависимости

Проект использует несколько библиотек (их список с версиями есть в файле `Cargo.toml`), в том числе:

1. `wgpu` - предоставляет доступ к графическому адаптеру, его бэкэнд строго установлен на Vulkan.
2. `png` - позволяет записывать картинки в файл в формате `.png`.
3. `csg` - написанная (мною) в рамках задания библиотека для построения и сериализации сцены, построенно с помощью коструктивной геометрии твёрдых тел. Расположена в каталоге `local/csg`.
4. `tokio` - предоставляет асинхронный runtime для Rust.
5. `clap` - позволяет очень просто парсить аргументы командной строки.
6. `rayon` - реализует "параллельные итераторы", что позволяет эффективно реализовать параллельный рендеринг на CPU.
7. `bytemuck` - позволяет кроссплатформено безопасно преобразовывать данные в байты и обратно без копирования.
8. `log` - типичный интерфейс логирования для Rust.
9. `env_logger` - реализует интерфейс `log` для `wgpu` и данного проекта, является иструментом логирования.
10. `glam` - предоставляет векторные типы и возможную из реализацию на SIMD (в зависимости от платформы).
11. `thiserror` - позволяет удобно работать с ошибками в Rust.
12. `serde` - интерфейс сериализации/десериализации для Rust.
13. `toml` - реализует интерфейс `serde` для сериализации/десериализации в формате `.toml`.

##  Отчёт о реализации

1. Реализована возможность рендеринга на одном потоке CPU, на всех потоках CPU и на GPU.
2. Программой производится вычесление времени работы алгоритмов с отдельным учётом времени копирования на GPU (работает с флагом `--bench`).
3. Для ускоренного рендеринга использовалось согласованное с преподавателем API `wgpu` и `rayon`.
4. Реализован анти-алиасинг суперсэмплингом четырьмя лучами под настраиваемым наклоном по отношению к текселю. (см. `local/csg/src/render/mod.rs:236` и `src/shaders/compute_image.wgsl:499`).
5. Реализованы резкие тени путём запуска луча по направлению источника света (см. `local/csg/src/render/mod.rs:108` и `src/shaders/compute_image.wgsl:400`).
6. Реализована настрока камеры, которая вращается вокруг настраемового центра, предусмотрена настройка вертикального угла обзора. (см. `render_config.toml:10`, `local/csg/src/render/mod.rs:214` и `src/shaders/render_image.wgsl:478`).
7. Реализованы итеративные отражения (см. `local/csg/src/render/mod.rs:87` и `src/shaders/compute_image.wgsl:376`).
8. Реализован ambient occlusion (см. `local/csg/src/render/mod.rs:146` и `src/shaders/compute_image.wgsl:349`).
9. Реализована одна фрактальная поверхность - mandelbulb (см. `local/csg/src/geometry.rs:220` и `src/shaders/compute_image.wgsl:78`).
10. Использованы приметивы коструктивной геометрии твёрдых тел: коробка, шар, полупространство, тор, mandelbulb, объединение (мягкое и жёсткое), пересечение (мягкое и жёсткое), дополнение (отрицание), разность (мягкая и жёсткая).
11. Для всех приметивов на сцене использован свой цвет, который смешивается согласно формуле $c=\frac{d_{2}c_{1}+d_{1}c_{2}}{d_{1}+d_{2}}$. (см. `local/csg/src/geometry:610` и `src/shaders/compute_image.wgsl:226`).
12. Сцена состоит из мягкого слияния нескольких шаров разного цвета (по центру), из которых вычитается фрактал mandelbulb, Также в середине расположена разность двух торов, которые образуют кольцо, всё это вписано в разность куба и шара, напоминающую клетку.
13. Все настройки рендеринга собраны в один конфигурационный файл `render_config.toml`.

## Отчёт о производительности

Вычислен наименьший результат по двум запускам на моём HUAWEI MateBook 16s / Intel i7 13700H / Intel Iris Xe Graphics / 16 GB.
В полях строки GPU <время рендеринга> + <время копирования>.

| Вычислитель/Разрешение | 1024x512                  | 2048x1024                  | 4096x2048                   |
| ---------------------- | ------------------------- | -------------------------- | --------------------------- |
| CPU (1 thread)         | 58.3331294с               | 232.0747946с               | 928.9533555с                |
| CPU (multithread)      | 6.2067614с                | 28.4705998с                | 120.8765138с                |
| GPU                    | 3.548409216с + 4.785333мс | 12.066554048с + 20.42353мс | 43.861391872с + 47.013249мс |
